<?xml version="1.0" encoding="UTF-8"?>
<Document>
  <Model version="4.1">
    <Sidops>
<![CDATA[cyl 0 0
    description '<Description>
   <IsMainModel>1</IsMainModel>
   <KeepParameterValues>True</KeepParameterValues>
   <Version>4.1</Version>
   <Description>Model generated by 3D-Mechanics Toolbox
	Original Filename: C:\Users\Shmuma\Work\RadioBoat\Sim\Stage1\cyl.3dm</Description>
   <LibraryPath>C:\Users\Shmuma\Work\RadioBoat\Sim\Stage1\cyl.emx</LibraryPath>
   <TimeStamp>2011-3-26 10:21:3</TimeStamp>
</Description>';
type MechanicsModel
  ports
    rotation psi in TorqueX1;
  restrictions
    causality fixed in TorqueX1;
end;
icon bg bottom
 figures
  image 'C:\Users\Shmuma\Work\RadioBoat\Sim\Stage1\cylIcon.png' 0 0 128 128;
end;implementation eq
// 20-sim 3D Mechanics Editor
// C:\Users\Shmuma\Work\RadioBoat\Sim\Stage1\cyl.3dm

variables
	real hidden World\AbsH[4,4];
	real hidden World\mass_x_I[6,6];
	real hidden CylFree\ConnectionPoint1\AbsH[4,4];
	real hidden CylFree\AbsH[4,4];
	real hidden CylFree\RelH[4,4];
	real hidden CylFree\rotationInitial[4,4];
	real CylFree\quat[4];
	real CylFree\quatDot[4];
	real hidden CylFree\quatInitial[4];
	real CylFree\QOmega[4,4];
	real CylFree\vgen[6];
	real CylFree\x[3];
	real CylFree\v[3];
	real CylFree\vel[3];
	real CylFree_Rot[4,4];
	real hidden CylFree\ConnectionPoint2\AbsH[4,4];
	real hidden Cyl\AbsH[4,4];
	real hidden Cyl\mass_x_I[6,6];
	real hidden TorqueX1\ConnectionPoint1\AbsH[4,4];
	real hidden FloorFree\ConnectionPoint1\AbsH[4,4];
	real hidden FloorFree\AbsH[4,4];
	real hidden FloorFree\RelH[4,4];
	real hidden FloorFree\rotationInitial[4,4];
	real FloorFree\quat[4];
	real FloorFree\quatDot[4];
	real hidden FloorFree\quatInitial[4];
	real FloorFree\QOmega[4,4];
	real FloorFree\vgen[6];
	real FloorFree\x[3];
	real FloorFree\v[3];
	real FloorFree\vel[3];
	real FloorFree_Rot[4,4];
	real hidden FloorFree\ConnectionPoint2\AbsH[4,4];
	real hidden Floor\AbsH[4,4];
	real hidden Floor\mass_x_I[6,6];
	real v[12];
	real P[12];
	real PDot[12];
	real PDotBodies[12];
	real hidden AdjX1[6,6];
	real hidden AdjX1_T[6,6];
	real hidden adjAdjX1_1[6,6];
	real hidden adjAdjX1_2[6,6];
	real hidden adjAdjX1_3[6,6];
	real hidden adjAdjX1_4[6,6];
	real hidden adjAdjX1_5[6,6];
	real hidden adjAdjX1_6[6,6];
	real hidden AdjX2[6,6];
	real hidden AdjX2_T[6,6];
	real hidden adjAdjX2_1[6,6];
	real hidden adjAdjX2_2[6,6];
	real hidden adjAdjX2_3[6,6];
	real hidden adjAdjX2_4[6,6];
	real hidden adjAdjX2_5[6,6];
	real hidden adjAdjX2_6[6,6];
	real hidden J1[6,12];
	real hidden J2[6,12];
	real hidden T1_00[6];
	real hidden T1_00T[1,6];
	real hidden T2_00[6];
	real hidden T2_00T[1,6];
	real hidden M1[6,6];
	real hidden AdjInv1[6,6];
	real hidden TM1[1,6];
	real hidden M2[6,6];
	real hidden AdjInv2[6,6];
	real hidden TM2[1,6];
	real MassMatrix[12,12];
	real hidden M1_1[6,6];
	real hidden M2_2[6,6];
	real hidden wrenchGrav1[1,6];
	real hidden wrenchGrav2[1,6];
	real TorqueX1\ConnectionPoint1\invAdjointH[6,6];
	real TorqueX1\ConnectionPoint1\AbsHinverse[4,4];
	real hidden TorqueX1_Effort[6];
	real hidden TorqueX1_Flow[6];
	real CylFree\Bk[6,6];
	real hidden CylFree\skewP4to6[3,3];
	real TMSum1[1,6];
	real FloorFree\Bk[6,6];
	real hidden FloorFree\skewP4to6[3,3];
	real TMSum2[1,6];
parameters
	real hidden World\H[4,4] = [
			1, 0, 0, 0;
			0, 1, 0, 0;
			0, 0, 1, 0;
			0, 0, 0, 1];
	real hidden World\I[6,6] = [
			0.1, 0, 0, 0, 0, 0;
			0, 0.1, 0, 0, 0, 0;
			0, 0, 0.1, 0, 0, 0;
			0, 0, 0, 1, 0, 0;
			0, 0, 0, 0, 1, 0;
			0, 0, 0, 0, 0, 1];
	real World\mass = 1;
	real hidden CylFree\ConnectionPoint1\RelH[4,4] = [
			1, 0, 0, 0;
			0, 1, 0, 0;
			0, 0, 1, 0;
			0, 0, 0, 1];
	real CylFree\EulerXYZInitial[3] = [0; 0; 0];
	real hidden CylFree\xInitial[3] = [1; -0.1; -1.87469972832732e-033];
	real hidden Cyl\RelH[4,4] = [
			1, 0, 0, 0;
			0, 1, 0, 0;
			0, 0, 1, 0;
			0, 0, 0, 1];
	real hidden Cyl\I[6,6] = [
			0.1, 0, 0, 0, 0, 0;
			0, 0.1, 0, 0, 0, 0;
			0, 0, 0.1, 0, 0, 0;
			0, 0, 0, 1, 0, 0;
			0, 0, 0, 0, 1, 0;
			0, 0, 0, 0, 0, 1];
	real Cyl\mass = 1;
	real hidden TorqueX1\ConnectionPoint1\RelH[4,4] = [
			1, 0, 0, -2.1;
			0, 1, 0, -0.2;
			0, 0, 1, 0;
			0, 0, 0, 1];
	real hidden FloorFree\ConnectionPoint1\RelH[4,4] = [
			1, 0, 0, 0;
			0, 1, 0, 0;
			0, 0, 1, 0;
			0, 0, 0, 1];
	real FloorFree\EulerXYZInitial[3] = [0; 0; 0];
	real hidden FloorFree\xInitial[3] = [3.2; 2; 0];
	real hidden Floor\RelH[4,4] = [
			1, 0, 0, 0;
			0, 1, 0, 0;
			0, 0, 1, 0;
			0, 0, 0, 1];
	real hidden Floor\I[6,6] = [
			0.1, 0, 0, 0, 0, 0;
			0, 0.1, 0, 0, 0, 0;
			0, 0, 0.1, 0, 0, 0;
			0, 0, 0, 1, 0, 0;
			0, 0, 0, 0, 1, 0;
			0, 0, 0, 0, 0, 1];
	real Floor\mass = 1;
	real gravity[3] = [0; 0; -9.81];
	real hidden PDotInitial[12] = [0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0];
initialequations
	CylFree\rotationInitial = dll ('EulerAngles.dll', 'HMatrixFromEulXYZr', CylFree\EulerXYZInitial);
	CylFree\quatInitial = dll ('EulerAngles.dll', 'QuaternionFromHMatrix', CylFree\rotationInitial);
	CylFree\RelH[4, 1:3] = 0;
	CylFree\RelH[4, 4] = 1;
	FloorFree\rotationInitial = dll ('EulerAngles.dll', 'HMatrixFromEulXYZr', FloorFree\EulerXYZInitial);
	FloorFree\quatInitial = dll ('EulerAngles.dll', 'QuaternionFromHMatrix', FloorFree\rotationInitial);
	FloorFree\RelH[4, 1:3] = 0;
	FloorFree\RelH[4, 4] = 1;
	J1[1:6, 7:12] = 0;
	J2[1:6, 1:6] = 0;
	MassMatrix[1:6, 7:12] = 0;
	MassMatrix[7:12, 1:6] = 0;
	CylFree\Bk[4:6, 4:6] = 0;
	FloorFree\Bk[4:6, 4:6] = 0;
equations
	World\AbsH = World\H;
	World\mass_x_I = World\mass * World\I;
	CylFree\ConnectionPoint1\AbsH = multiplyH (World\AbsH, CylFree\ConnectionPoint1\RelH);
	CylFree\QOmega = [0, -CylFree\vgen[3], CylFree\vgen[2], -CylFree\vgen[1];
				CylFree\vgen[3], 0, -CylFree\vgen[1], -CylFree\vgen[2];
				-CylFree\vgen[2], CylFree\vgen[1], 0, -CylFree\vgen[3];
				CylFree\vgen[1], CylFree\vgen[2], CylFree\vgen[3], 0];
	CylFree\quat = int (CylFree\quatDot) + CylFree\quatInitial;
	CylFree\quatDot = 0.5 * CylFree\QOmega * CylFree\quat;
	CylFree\vel = CylFree\vgen[4:6];
	CylFree\v = skew (CylFree\vgen[1:3]) * CylFree\x + CylFree\vel;
	CylFree\x = int (CylFree\v) + CylFree\xInitial;
	CylFree_Rot = dll ('EulerAngles.dll', 'HMatrixFromQuaternion', CylFree\quat);
	CylFree\RelH[1:3, 1:3] = CylFree_Rot[1:3, 1:3];
	CylFree\RelH[1:3, 4] = CylFree\x;
	CylFree\AbsH = multiplyH (CylFree\ConnectionPoint1\AbsH, CylFree\RelH);
	CylFree\ConnectionPoint2\AbsH = CylFree\AbsH;
	Cyl\AbsH = multiplyH (CylFree\ConnectionPoint2\AbsH, Cyl\RelH);
	Cyl\mass_x_I = Cyl\mass * Cyl\I;
	TorqueX1\ConnectionPoint1\AbsH = multiplyH (Cyl\AbsH, TorqueX1\ConnectionPoint1\RelH);
	FloorFree\ConnectionPoint1\AbsH = multiplyH (World\AbsH, FloorFree\ConnectionPoint1\RelH);
	FloorFree\QOmega = [0, -FloorFree\vgen[3], FloorFree\vgen[2], -FloorFree\vgen[1];
				FloorFree\vgen[3], 0, -FloorFree\vgen[1], -FloorFree\vgen[2];
				-FloorFree\vgen[2], FloorFree\vgen[1], 0, -FloorFree\vgen[3];
				FloorFree\vgen[1], FloorFree\vgen[2], FloorFree\vgen[3], 0];
	FloorFree\quat = int (FloorFree\quatDot) + FloorFree\quatInitial;
	FloorFree\quatDot = 0.5 * FloorFree\QOmega * FloorFree\quat;
	FloorFree\vel = FloorFree\vgen[4:6];
	FloorFree\v = skew (FloorFree\vgen[1:3]) * FloorFree\x + FloorFree\vel;
	FloorFree\x = int (FloorFree\v) + FloorFree\xInitial;
	FloorFree_Rot = dll ('EulerAngles.dll', 'HMatrixFromQuaternion', FloorFree\quat);
	FloorFree\RelH[1:3, 1:3] = FloorFree_Rot[1:3, 1:3];
	FloorFree\RelH[1:3, 4] = FloorFree\x;
	FloorFree\AbsH = multiplyH (FloorFree\ConnectionPoint1\AbsH, FloorFree\RelH);
	FloorFree\ConnectionPoint2\AbsH = FloorFree\AbsH;
	Floor\AbsH = multiplyH (FloorFree\ConnectionPoint2\AbsH, Floor\RelH);
	Floor\mass_x_I = Floor\mass * Floor\I;
	AdjX1 = Adjoint (CylFree\ConnectionPoint1\AbsH);
	AdjX1_T = transpose (AdjX1);
	adjAdjX1_1 = adjoint (AdjX1[1:6, 1]);
	adjAdjX1_2 = adjoint (AdjX1[1:6, 2]);
	adjAdjX1_3 = adjoint (AdjX1[1:6, 3]);
	adjAdjX1_4 = adjoint (AdjX1[1:6, 4]);
	adjAdjX1_5 = adjoint (AdjX1[1:6, 5]);
	adjAdjX1_6 = adjoint (AdjX1[1:6, 6]);
	AdjX2 = Adjoint (FloorFree\ConnectionPoint1\AbsH);
	AdjX2_T = transpose (AdjX2);
	adjAdjX2_1 = adjoint (AdjX2[1:6, 1]);
	adjAdjX2_2 = adjoint (AdjX2[1:6, 2]);
	adjAdjX2_3 = adjoint (AdjX2[1:6, 3]);
	adjAdjX2_4 = adjoint (AdjX2[1:6, 4]);
	adjAdjX2_5 = adjoint (AdjX2[1:6, 5]);
	adjAdjX2_6 = adjoint (AdjX2[1:6, 6]);
	J1[1:6, 1:6] = AdjX1;
	J2[1:6, 7:12] = AdjX2;
	T1_00 = J1 * v;
	T1_00T = transpose (T1_00);
	T2_00 = J2 * v;
	T2_00T = transpose (T2_00);
	AdjInv1 = Adjoint (inverseH (Cyl\AbsH));
	M1 = transpose (AdjInv1) * Cyl\mass_x_I * AdjInv1;
	TM1 = T1_00T * M1;
	AdjInv2 = Adjoint (inverseH (Floor\AbsH));
	M2 = transpose (AdjInv2) * Floor\mass_x_I * AdjInv2;
	TM2 = T2_00T * M2;
	M1_1 = AdjX1_T * M1 * AdjX1;
	M2_2 = AdjX2_T * M2 * AdjX2;
	MassMatrix[1:6, 1:6] = M1_1;
	MassMatrix[7:12, 7:12] = M2_2;
	wrenchGrav1 = Cyl\mass * [gravity[3] * Cyl\AbsH[2, 4] - gravity[2] * Cyl\AbsH[3, 4], gravity[1] * Cyl\AbsH[3, 4] - gravity[3] * Cyl\AbsH[1, 4], gravity[2] * Cyl\AbsH[1, 4] - gravity[1] * Cyl\AbsH[2, 4], gravity[1], gravity[2], gravity[3]];
	wrenchGrav2 = Floor\mass * [gravity[3] * Floor\AbsH[2, 4] - gravity[2] * Floor\AbsH[3, 4], gravity[1] * Floor\AbsH[3, 4] - gravity[3] * Floor\AbsH[1, 4], gravity[2] * Floor\AbsH[1, 4] - gravity[1] * Floor\AbsH[2, 4], gravity[1], gravity[2], gravity[3]];
	TorqueX1\ConnectionPoint1\AbsHinverse = inverseH (TorqueX1\ConnectionPoint1\AbsH);
	TorqueX1\ConnectionPoint1\invAdjointH = Adjoint (TorqueX1\ConnectionPoint1\AbsHinverse);
	TorqueX1_Effort[1] = TorqueX1.e;
	TorqueX1_Effort[2] = 0;
	TorqueX1_Effort[3] = 0;
	TorqueX1_Effort[4] = 0;
	TorqueX1_Effort[5] = 0;
	TorqueX1_Effort[6] = 0;
	TorqueX1_Flow = TorqueX1\ConnectionPoint1\invAdjointH * T1_00;
	TorqueX1.f = TorqueX1_Flow[1];
	CylFree\skewP4to6 = skew (P[4:6]);
	CylFree\Bk[1:3, 1:3] = skew (P[1:3]);
	CylFree\Bk[4:6, 1:3] = CylFree\skewP4to6;
	CylFree\Bk[1:3, 4:6] = CylFree\skewP4to6;
	TMSum1 = TM1;
	PDotBodies[1:6] = -[TMSum1 * adjAdjX1_1 * T1_00;
				TMSum1 * adjAdjX1_2 * T1_00;
				TMSum1 * adjAdjX1_3 * T1_00;
				TMSum1 * adjAdjX1_4 * T1_00;
				TMSum1 * adjAdjX1_5 * T1_00;
				TMSum1 * adjAdjX1_6 * T1_00] - CylFree\Bk * v[1:6];
	FloorFree\skewP4to6 = skew (P[10:12]);
	FloorFree\Bk[1:3, 1:3] = skew (P[7:9]);
	FloorFree\Bk[4:6, 1:3] = FloorFree\skewP4to6;
	FloorFree\Bk[1:3, 4:6] = FloorFree\skewP4to6;
	TMSum2 = TM2;
	PDotBodies[7:12] = -[TMSum2 * adjAdjX2_1 * T2_00;
				TMSum2 * adjAdjX2_2 * T2_00;
				TMSum2 * adjAdjX2_3 * T2_00;
				TMSum2 * adjAdjX2_4 * T2_00;
				TMSum2 * adjAdjX2_5 * T2_00;
				TMSum2 * adjAdjX2_6 * T2_00] - FloorFree\Bk * v[7:12];
	PDot = PDotBodies + transpose (wrenchGrav1 * J1 + wrenchGrav2 * J2 + transpose (TorqueX1_Effort) * TorqueX1\ConnectionPoint1\invAdjointH * J1);
	P = int (PDot) + PDotInitial;
	v = linsolve (MassMatrix, P, 'cholesky');
	CylFree\vgen = v[1:6];
	FloorFree\vgen = v[7:12];
implementation_end;
]]>
    </Sidops>
  </Model>
</Document>
